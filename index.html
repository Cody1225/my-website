<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pi-Fi 控制面板 (液態玻璃風格)</title>
    <!-- 載入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 載入 Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- 載入 Lucide Icons (用於編輯圖標) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        /* 應用 Apple 液態玻璃 (Frosted Glass) 效果 */
        .frosted-glass {
            background-color: rgba(255, 255, 255, 0.2);
            /* 核心模糊效果 */
            backdrop-filter: blur(16px) saturate(180%);
            -webkit-backdrop-filter: blur(16px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.125);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }

        /* 確保按鈕在拖曳時在頂層 */
        .draggable-button {
            touch-action: none; /* 禁用瀏覽器預設的觸控行為 */
            position: absolute;
            transition: opacity 0.2s; /* 讓編輯模式切換更平滑 */
        }

        /* 整個 App 的背景：使用漸層營造質感 */
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #1f2937, #374151);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* 確保 App 容器在行動裝置上滿版 */
        #app {
            width: 100%;
            max-width: 600px; /* 模擬手機或平板介面寬度 */
            height: 100vh;
            max-height: 800px; /* 模擬手機介面高度 */
            border-radius: 30px;
            overflow: hidden;
            position: relative;
        }

        /* 覆蓋 Lucide Icons 的樣式 */
        .icon {
            stroke-width: 2.5;
        }
    </style>
</head>
<body>

<div id="app">
    <div class="frosted-glass p-4 h-full flex flex-col">
        <!-- 標題列 (Header) -->
        <header class="flex justify-between items-center pb-4 text-white">
            <h1 class="text-xl font-bold">
                Wi-Fi 控制台
                <span :class="{'text-green-400': isConnected, 'text-red-400': !isConnected}" class="text-sm font-normal ml-2">
                    ({{ isConnected ? '連線中' : '未連線' }})
                </span>
            </h1>
            <div class="flex space-x-2">
                <!-- 編輯/完成按鈕 -->
                <button 
                    @click="isEditing = !isEditing"
                    :class="isEditing ? 'bg-orange-500' : 'bg-blue-500'"
                    class="frosted-glass px-4 py-1.5 text-white rounded-full transition duration-300 hover:scale-105"
                >
                    {{ isEditing ? '完成' : '編輯' }}
                </button>
                <!-- 新增按鈕 -->
                <button v-if="isEditing" 
                    @click="addButton"
                    class="frosted-glass p-2 bg-green-500 text-white rounded-full hover:scale-105 transition duration-300"
                >
                    <i data-lucide="plus" class="icon w-5 h-5"></i>
                </button>
            </div>
        </header>

        <!-- 控制面板 (Control Pad) -->
        <div 
            ref="controlPad" 
            class="flex-1 relative rounded-xl overflow-hidden shadow-2xl bg-gray-900/10 border border-gray-700/50"
        >
            <div v-if="buttonConfigs.length === 0" class="flex items-center justify-center h-full text-gray-400">
                <p>點擊右上角 '+' 新增您的第一個控制按鈕</p>
            </div>

            <!-- 渲染所有按鈕 -->
            <div v-for="config in buttonConfigs" :key="config.id"
                :id="config.id"
                class="draggable-button rounded-xl"
                :style="{ 
                    left: `${config.x}px`, 
                    top: `${config.y}px`, 
                    width: `${config.width}px`, 
                    height: `${config.height}px`,
                    zIndex: isEditing ? 10 : 1, /* 編輯模式下層級較高 */
                    opacity: isEditing ? 0.8 : 1
                }"
                @mousedown="startDrag($event, config.id)"
                @touchstart="startDrag($event, config.id)"
                @dblclick="openEditor(config)"
                @contextmenu.prevent="openEditor(config)"
            >
                <div class="w-full h-full rounded-xl flex items-center justify-center p-2 transition duration-150"
                    :style="{ 
                        backgroundColor: config.colorHex ? '#' + config.colorHex : '#4b5563', /* 背景色 */
                        boxShadow: isEditing ? '0 0 10px rgba(255, 255, 0, 0.8)' : 'none'
                    }"
                    @click="!isEditing && sendMessage(config.messageToSend)"
                >
                    <span 
                        :style="{ 
                            color: '#' + config.fontColorHex,
                            fontSize: config.fontSize + 'px'
                        }"
                        class="font-semibold text-center select-none truncate"
                    >
                        {{ config.label }}
                    </span>

                    <!-- 編輯模式下顯示的 Resize 區塊 (右下角) -->
                    <div v-if="isEditing" 
                        class="absolute bottom-0 right-0 w-8 h-8 rounded-full bg-black/60 cursor-se-resize flex items-center justify-center text-yellow-400 hover:scale-110"
                        @mousedown.stop="startResize($event, config.id)"
                        @touchstart.stop="startResize($event, config.id)"
                    >
                        <i data-lucide="maximize-2" class="icon w-4 h-4"></i>
                    </div>
                    
                     <!-- 編輯模式下顯示的 Edit 區塊 (左上角) -->
                    <div v-if="isEditing" 
                        class="absolute top-0 left-0 w-8 h-8 rounded-full bg-black/60 cursor-pointer flex items-center justify-center text-blue-400 hover:scale-110"
                        @click.stop="openEditor(config)"
                    >
                        <i data-lucide="edit" class="icon w-4 h-4"></i>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 底部資訊/設定按鈕 -->
        <footer class="pt-4 flex justify-between items-center text-white/70">
            <span class="text-sm">樹莓派 IP: {{ rpiIp }}</span>
            <button class="text-sm frosted-glass px-3 py-1 rounded-full bg-gray-700/50 hover:bg-gray-600/50 transition">
                設定
            </button>
        </footer>
    </div>
    
    <!-- 編輯器彈窗 (Modal) -->
    <div v-if="editingConfig" class="fixed inset-0 bg-black/50 z-20 flex items-center justify-center p-4">
        <div class="frosted-glass p-6 rounded-3xl w-full max-w-sm border border-gray-400/50 shadow-2xl">
            <h2 class="text-xl font-bold text-white mb-4">編輯按鈕</h2>
            
            <!-- 內容編輯 -->
            <div class="space-y-4">
                <label class="block text-white/80">按鈕文字</label>
                <input type="text" v-model="editingConfig.label" class="w-full p-2 rounded-lg bg-white/10 border border-white/20 text-white focus:ring-blue-500 focus:border-blue-500" />
                
                <label class="block text-white/80">發送指令</label>
                <input type="text" v-model="editingConfig.messageToSend" class="w-full p-2 rounded-lg bg-white/10 border border-white/20 text-white focus:ring-blue-500 focus:border-blue-500" />
            </div>

            <div class="h-px bg-white/20 my-4"></div>

            <!-- 樣式編輯 -->
            <div class="space-y-4">
                <label class="block text-white/80">按鈕背景顏色</label>
                <input type="color" :value="'#' + editingConfig.colorHex" @input="event => editingConfig.colorHex = event.target.value.substring(1).toUpperCase()" class="w-full h-10 cursor-pointer" />
                
                <label class="block text-white/80">文字顏色</label>
                <input type="color" :value="'#' + editingConfig.fontColorHex" @input="event => editingConfig.fontColorHex = event.target.value.substring(1).toUpperCase()" class="w-full h-10 cursor-pointer" />

                <label class="block text-white/80">字體大小: {{ Math.round(editingConfig.fontSize) }} px</label>
                <input type="range" min="10" max="40" step="1" v-model.number="editingConfig.fontSize" class="w-full h-2 bg-white/20 rounded-lg appearance-none cursor-pointer range-lg" />
            </div>
            
            <div class="h-px bg-white/20 my-4"></div>

            <!-- 動作按鈕 -->
            <div class="flex justify-between space-x-3">
                <button 
                    @click="removeButton(editingConfig.id)"
                    class="w-full p-3 rounded-xl bg-red-600 text-white font-semibold hover:bg-red-700 transition"
                >
                    刪除
                </button>
                <button 
                    @click="saveEditor"
                    class="w-full p-3 rounded-xl bg-blue-500 text-white font-semibold hover:bg-blue-600 transition"
                >
                    儲存並關閉
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    const { createApp, ref, onMounted, nextTick } = Vue;

    // --- 輔助函式：顏色轉換 ---
    function hexToRgb(hex) {
        // 移除 # 符號
        const bigint = parseInt(hex, 16);
        const r = (bigint >> 16) & 255;
        const g = (bigint >> 8) & 255;
        const b = bigint & 255;
        return [r, g, b];
    }
    
    // --- 輔助函式：預設設定 ---
    const DEFAULT_CONFIG = {
        id: '',
        label: '新指令',
        messageToSend: 'NEW',
        colorHex: '7E57C2', // Deep Purple
        x: 100, 
        y: 100,
        width: 120, 
        height: 60,
        fontSize: 20,
        fontColorHex: 'FFFFFF'
    };

    // --- Vue 應用程式邏輯 ---
    const App = {
        setup() {
            // 狀態變數
            const buttonConfigs = ref([]);
            const isEditing = ref(false); // 編輯/控制模式切換
            const editingConfig = ref(null); // 當前正在編輯的按鈕
            const rpiIp = ref('192.168.1.100'); // 樹莓派 IP (請替換為您的實際 IP)
            const isConnected = ref(false); // 模擬連線狀態
            
            const controlPad = ref(null); // 參考控制面板元素
            
            // 拖曳/縮放狀態
            let activeDragId = null;
            let initialX = 0;
            let initialY = 0;
            let initialConfig = null;
            let mode = null; // 'drag' or 'resize'

            // --- 資料持久化 ---
            const CONFIG_KEY = 'RpiControllerConfigs';

            function loadConfigs() {
                const saved = localStorage.getItem(CONFIG_KEY);
                if (saved) {
                    try {
                        buttonConfigs.value = JSON.parse(saved);
                    } catch (e) {
                        console.error("載入配置失敗，使用預設值:", e);
                        buttonConfigs.value = [
                            { ...DEFAULT_CONFIG, id: 'btn1', label: '燈光 ON', messageToSend: 'A', colorHex: '34C759', x: 80, y: 80 },
                            { ...DEFAULT_CONFIG, id: 'btn2', label: '燈光 OFF', messageToSend: 'B', colorHex: 'FF3B30', x: 80, y: 160 },
                            { ...DEFAULT_CONFIG, id: 'btn3', label: '模式切換', messageToSend: 'C', colorHex: '007AFF', x: 240, y: 80 },
                        ];
                    }
                } else {
                     buttonConfigs.value = [
                        { ...DEFAULT_CONFIG, id: 'btn1', label: '燈光 ON', messageToSend: 'A', colorHex: '34C759', x: 80, y: 80 },
                        { ...DEFAULT_CONFIG, id: 'btn2', label: '燈光 OFF', messageToSend: 'B', colorHex: 'FF3B30', x: 80, y: 160 },
                        { ...DEFAULT_CONFIG, id: 'btn3', label: '模式切換', messageToSend: 'C', colorHex: '007AFF', x: 240, y: 80 },
                    ];
                }
                // 為了兼容，檢查並確保每個按鈕都有新的字體屬性
                 buttonConfigs.value = buttonConfigs.value.map(config => ({
                    ...DEFAULT_CONFIG,
                    ...config,
                    id: config.id || crypto.randomUUID(),
                    fontSize: config.fontSize || DEFAULT_CONFIG.fontSize,
                    fontColorHex: config.fontColorHex || DEFAULT_CONFIG.fontColorHex
                }));
            }

            function saveConfigs() {
                localStorage.setItem(CONFIG_KEY, JSON.stringify(buttonConfigs.value));
            }
            
            // --- 樹莓派通訊邏輯 (HTTP) ---
            async function sendMessage(message) {
                if (isEditing.value) return; // 編輯模式下不發送指令

                const url = `http://${rpiIp.value}:5000/command`; // 假設樹莓派在 5000 port 運行 Flask 服務

                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ command: message })
                    });

                    if (response.ok) {
                        console.log(`指令 [${message}] 發送成功！`);
                    } else {
                        console.error(`發送失敗，RPI 返回狀態碼: ${response.status}`);
                    }
                } catch (error) {
                    console.error(`無法連線到 RPI (${rpiIp.value})，請檢查網路設定:`, error);
                    // 實際應用中可以在這裡顯示錯誤訊息給用戶
                }
            }
            
            // --- 按鈕操作 ---

            function addButton() {
                const newId = crypto.randomUUID();
                const newConfig = { 
                    ...DEFAULT_CONFIG, 
                    id: newId, 
                    x: (controlPad.value.clientWidth / 2) - (DEFAULT_CONFIG.width / 2),
                    y: (controlPad.value.clientHeight / 2) - (DEFAULT_CONFIG.height / 2),
                };
                buttonConfigs.value.push(newConfig);
                saveConfigs();
            }

            function removeButton(idToRemove) {
                buttonConfigs.value = buttonConfigs.value.filter(c => c.id !== idToRemove);
                editingConfig.value = null;
                saveConfigs();
            }

            function openEditor(config) {
                if (isEditing.value) {
                    // 使用 JSON.parse(JSON.stringify) 進行深拷貝，避免直接修改原始數據
                    editingConfig.value = JSON.parse(JSON.stringify(config));
                }
            }

            function saveEditor() {
                if (editingConfig.value) {
                    const index = buttonConfigs.value.findIndex(c => c.id === editingConfig.value.id);
                    if (index !== -1) {
                        // 更新原始配置
                        buttonConfigs.value[index] = editingConfig.value;
                        saveConfigs();
                    }
                }
                editingConfig.value = null;
            }


            // --- 拖曳/縮放邏輯 ---
            function getConfig(id) {
                return buttonConfigs.value.find(c => c.id === id);
            }

            function getEventCoords(event) {
                if (event.touches) {
                    return { x: event.touches[0].clientX, y: event.touches[0].clientY };
                }
                return { x: event.clientX, y: event.clientY };
            }

            function startDrag(event, id) {
                if (!isEditing.value || mode === 'resize') return;
                
                // 阻止瀏覽器處理 (防止手機上滾動)
                event.preventDefault(); 
                
                mode = 'drag';
                activeDragId = id;
                initialConfig = getConfig(id);
                
                const coords = getEventCoords(event);
                initialX = coords.x;
                initialY = coords.y;
                
                document.addEventListener('mousemove', handleMove);
                document.addEventListener('mouseup', handleEnd);
                document.addEventListener('touchmove', handleMove);
                document.addEventListener('touchend', handleEnd);
            }

            function startResize(event, id) {
                if (!isEditing.value || mode === 'drag') return;
                
                // 阻止瀏覽器處理 (防止手機上滾動)
                event.preventDefault(); 
                event.stopPropagation(); // 阻止事件冒泡到 drag 邏輯
                
                mode = 'resize';
                activeDragId = id;
                initialConfig = getConfig(id);
                
                const coords = getEventCoords(event);
                initialX = coords.x;
                initialY = coords.y;
                
                document.addEventListener('mousemove', handleMove);
                document.addEventListener('mouseup', handleEnd);
                document.addEventListener('touchmove', handleMove);
                document.addEventListener('touchend', handleEnd);
            }

            function handleMove(event) {
                if (!activeDragId || !initialConfig || !controlPad.value) return;
                
                const currentConfig = getConfig(activeDragId);
                if (!currentConfig) return;

                const coords = getEventCoords(event);
                const deltaX = coords.x - initialX;
                const deltaY = coords.y - initialY;
                
                const containerRect = controlPad.value.getBoundingClientRect();

                if (mode === 'drag') {
                    // 計算新的中心位置
                    let newX = initialConfig.x + deltaX;
                    let newY = initialConfig.y + deltaY;
                    
                    // 限制邊界
                    newX = Math.max(currentConfig.width / 2, Math.min(newX, containerRect.width - currentConfig.width / 2));
                    newY = Math.max(currentConfig.height / 2, Math.min(newY, containerRect.height - currentConfig.height / 2));

                    currentConfig.x = newX;
                    currentConfig.y = newY;
                } else if (mode === 'resize') {
                    // 計算新的尺寸
                    let newWidth = initialConfig.width + deltaX;
                    let newHeight = initialConfig.height + deltaY;
                    
                    // 限制最小尺寸，並限制在容器內
                    newWidth = Math.max(80, newWidth);
                    newHeight = Math.max(40, newHeight);
                    
                    // 檢查新的尺寸是否會超出右邊界或下邊界
                    const currentRight = initialConfig.x + initialConfig.width / 2 + deltaX;
                    const currentBottom = initialConfig.y + initialConfig.height / 2 + deltaY;

                    if (currentRight < containerRect.width && currentBottom < containerRect.height) {
                         currentConfig.width = newWidth;
                         currentConfig.height = newHeight;
                    }
                }
            }

            function handleEnd() {
                if (activeDragId) {
                    saveConfigs(); // 結束拖曳/縮放時儲存
                }
                mode = null;
                activeDragId = null;
                initialConfig = null;
                
                document.removeEventListener('mousemove', handleMove);
                document.removeEventListener('mouseup', handleEnd);
                document.removeEventListener('touchmove', handleMove);
                document.removeEventListener('touchend', handleEnd);
            }

            // --- 生命周期鉤子 ---
            onMounted(() => {
                loadConfigs();
                // 初始化 Lucide Icons
                lucide.createIcons();
                // 模擬連線成功，實際應用中應有連線檢查邏輯
                setTimeout(() => { isConnected.value = true; }, 1000); 
            });

            return {
                buttonConfigs,
                isEditing,
                editingConfig,
                rpiIp,
                isConnected,
                controlPad,
                
                // 方法
                addButton,
                removeButton,
                openEditor,
                saveEditor,
                sendMessage,
                
                // 拖曳/縮放
                startDrag,
                startResize,
                Math, // 暴露 Math 對象給模板使用
            };
        }
    };

    createApp(App).mount('#app');
</script>
</body>
</html>